{
    "name": "LinkedIn AI Content Engine",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "cronExpression",
                            "expression": "0 9,16 * * *"
                        }
                    ]
                },
                "timezone": "America/Chicago"
            },
            "id": "cron-trigger",
            "name": "Schedule Trigger",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1,
            "position": [250, 300]
        },
        {
            "parameters": {
                "jsCode": "// Content rotation logic\nconst templateRotation = ['interview_explainer', 'architecture', 'optimization', 'layered'];\n\n// Get state from previous runs\nconst lastTemplateIndex = $node['Get State'].json.lastTemplateIndex || 0;\nconst usedTopics = $node['Get State'].json.usedTopics || {};\n\n// Rotate to next template\nconst currentTemplateIndex = (lastTemplateIndex + 1) % templateRotation.length;\nconst currentTemplate = templateRotation[currentTemplateIndex];\n\n// Get topics for this template\nconst topicBank = $input.item.json.topicBank;\nconst availableTopics = topicBank[currentTemplate];\n\n// Filter out recently used topics\nconst recentlyUsed = usedTopics[currentTemplate] || [];\nconst freshTopics = availableTopics.filter(t => !recentlyUsed.includes(t));\n\n// If all topics used, reset\nconst topicsToUse = freshTopics.length > 0 ? freshTopics : availableTopics;\nconst selectedTopic = topicsToUse[0];\n\n// Update used topics tracking\nif (!usedTopics[currentTemplate]) {\n  usedTopics[currentTemplate] = [];\n}\nusedTopics[currentTemplate].push(selectedTopic);\n\n// Keep only last 3 used topics per template\nif (usedTopics[currentTemplate].length > 3) {\n  usedTopics[currentTemplate].shift();\n}\n\n// Map template to prompt file\nconst promptFileMap = {\n  'interview_explainer': 'prompts/interview-explainer.md',\n  'architecture': 'prompts/architecture-comparison.md',\n  'optimization': 'prompts/optimization-story.md',\n  'layered': 'prompts/layered-mental-model.md'\n};\n\nreturn {\n  json: {\n    template: currentTemplate,\n    topic: selectedTopic,\n    promptFile: promptFileMap[currentTemplate],\n    timestamp: new Date().toISOString(),\n    newState: {\n      lastTemplateIndex: currentTemplateIndex,\n      usedTopics: usedTopics\n    }\n  }\n};"
            },
            "id": "content-planner",
            "name": "Plan Content",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [650, 300]
        },
        {
            "parameters": {
                "authentication": "oAuth2",
                "resource": "file",
                "operation": "get",
                "owner": "={{ $json.repo_owner }}",
                "repository": "={{ $json.repo_name }}",
                "filePath": "={{ $node['Plan Content'].json.promptFile }}"
            },
            "id": "fetch-prompt",
            "name": "Fetch Prompt",
            "type": "n8n-nodes-base.github",
            "typeVersion": 1,
            "position": [850, 200]
        },
        {
            "parameters": {
                "authentication": "oAuth2",
                "resource": "file",
                "operation": "get",
                "owner": "={{ $json.repo_owner }}",
                "repository": "={{ $json.repo_name }}",
                "filePath": "content-spec/tone.md"
            },
            "id": "fetch-tone",
            "name": "Fetch Tone",
            "type": "n8n-nodes-base.github",
            "typeVersion": 1,
            "position": [850, 300]
        },
        {
            "parameters": {
                "authentication": "oAuth2",
                "resource": "file",
                "operation": "get",
                "owner": "={{ $json.repo_owner }}",
                "repository": "={{ $json.repo_name }}",
                "filePath": "topics/topic-bank.json"
            },
            "id": "fetch-topics",
            "name": "Fetch Topics",
            "type": "n8n-nodes-base.github",
            "typeVersion": 1,
            "position": [450, 300]
        },
        {
            "parameters": {
                "model": "gpt-4",
                "messages": {
                    "values": [
                        {
                            "role": "system",
                            "content": "You are a LinkedIn content creator for a senior data/AI engineer. Generate professional, educational content following the provided template and tone guidelines."
                        },
                        {
                            "role": "user",
                            "content": "=Template:\n{{ $node['Fetch Prompt'].json.content }}\n\nTone Guidelines:\n{{ $node['Fetch Tone'].json.content }}\n\nTopic: {{ $node['Plan Content'].json.topic }}\n\nGenerate a LinkedIn text post with:\n1. Caption (6-12 lines, ending with a thoughtful question to engage readers)\n2. 5-8 relevant hashtags\n\nReturn as JSON: {\"caption\": \"...\", \"hashtags\": [...]}"
                        }
                    ]
                },
                "options": {
                    "temperature": 0.7,
                    "maxTokens": 1000
                }
            },
            "id": "generate-content",
            "name": "Generate Content",
            "type": "n8n-nodes-base.openAi",
            "typeVersion": 1,
            "position": [1050, 300]
        },
        {
            "parameters": {
                "jsCode": "// Parse the OpenAI response\nconst aiResponse = $input.item.json.choices[0].message.content;\n\n// Extract JSON from response (handle markdown code blocks)\nlet contentData;\ntry {\n  const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);\n  contentData = JSON.parse(jsonMatch ? jsonMatch[0] : aiResponse);\n} catch (e) {\n  throw new Error('Failed to parse AI response as JSON: ' + aiResponse);\n}\n\n// Validate required fields\nif (!contentData.caption) {\n  throw new Error('Missing caption in AI response');\n}\n\n// Build full caption with hashtags\nconst hashtags = contentData.hashtags || [];\nconst hashtagString = hashtags.map(h => h.startsWith('#') ? h : '#' + h).join(' ');\nconst fullCaption = hashtags.length > 0 \n  ? `${contentData.caption}\\n\\n${hashtagString}`\n  : contentData.caption;\n\nreturn {\n  json: {\n    caption: contentData.caption,\n    hashtags: hashtags,\n    fullCaption: fullCaption,\n    topic: $node['Plan Content'].json.topic,\n    template: $node['Plan Content'].json.template,\n    timestamp: $node['Plan Content'].json.timestamp\n  }\n};"
            },
            "id": "parse-content",
            "name": "Parse Content",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [1250, 300]
        },
        {
            "parameters": {
                "resource": "post",
                "text": "={{ $json.fullCaption }}"
            },
            "id": "post-linkedin",
            "name": "Post to LinkedIn",
            "type": "n8n-nodes-base.linkedIn",
            "typeVersion": 1,
            "position": [1450, 300],
            "notes": "Text-only post. Add image support later by adding mediaUrl parameter."
        },
        {
            "parameters": {
                "jsCode": "// Build log entry\nconst existing = $input.item.json.existingLog || [];\n\nconst newEntry = {\n  timestamp: $node['Parse Content'].json.timestamp,\n  template: $node['Parse Content'].json.template,\n  topic: $node['Parse Content'].json.topic,\n  status: 'published',\n  linkedinPostId: $node['Post to LinkedIn'].json.id || 'N/A',\n  caption: $node['Parse Content'].json.caption.substring(0, 100) + '...',\n  hashtags: $node['Parse Content'].json.hashtags\n};\n\nexisting.unshift(newEntry);\n\n// Keep only last 100 entries\nif (existing.length > 100) {\n  existing.pop();\n}\n\nreturn {\n  json: {\n    posts: existing\n  }\n};"
            },
            "id": "build-log",
            "name": "Build Log Entry",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [1650, 300]
        },
        {
            "parameters": {
                "authentication": "oAuth2",
                "resource": "file",
                "operation": "edit",
                "owner": "={{ $json.repo_owner }}",
                "repository": "={{ $json.repo_name }}",
                "filePath": "automation/post_log.json",
                "fileContent": "={{ JSON.stringify($node['Build Log Entry'].json, null, 2) }}",
                "commitMessage": "chore: log post {{ $node['Parse Content'].json.timestamp }}"
            },
            "id": "log-to-github",
            "name": "Log to GitHub",
            "type": "n8n-nodes-base.github",
            "typeVersion": 1,
            "position": [1850, 300]
        },
        {
            "parameters": {
                "conditions": {
                    "boolean": [
                        {
                            "value1": "={{ $node['Generate Content'].json.error }}",
                            "value2": true
                        }
                    ]
                }
            },
            "id": "error-check",
            "name": "Check for Errors",
            "type": "n8n-nodes-base.if",
            "typeVersion": 1,
            "position": [1150, 500]
        },
        {
            "parameters": {
                "fromEmail": "notifications@yourdomain.com",
                "toEmail": "your-email@example.com",
                "subject": "n8n LinkedIn Workflow Error",
                "text": "=Error occurred in LinkedIn automation workflow.\n\nTimestamp: {{ $node['Plan Content'].json.timestamp }}\nTemplate: {{ $node['Plan Content'].json.template }}\nTopic: {{ $node['Plan Content'].json.topic }}\n\nError: {{ $node['Generate Content'].json.error }}"
            },
            "id": "send-error-email",
            "name": "Send Error Alert",
            "type": "n8n-nodes-base.emailSend",
            "typeVersion": 2,
            "position": [1350, 600],
            "notes": "Optional: Replace with Slack node for notifications"
        },
        {
            "parameters": {
                "mode": "raw",
                "jsonData": "{\n  \"lastTemplateIndex\": 0,\n  \"usedTopics\": {},\n  \"repo_owner\": \"jumahamdan\",\n  \"repo_name\": \"ai-data-content-engine\"\n}"
            },
            "id": "get-state",
            "name": "Get State",
            "type": "n8n-nodes-base.set",
            "typeVersion": 2,
            "position": [450, 200],
            "notes": "For persistent state, replace with Redis or database node"
        }
    ],
    "connections": {
        "Schedule Trigger": {
            "main": [[
                {"node": "Get State", "type": "main", "index": 0},
                {"node": "Fetch Topics", "type": "main", "index": 0}
            ]]
        },
        "Get State": {
            "main": [[{"node": "Plan Content", "type": "main", "index": 0}]]
        },
        "Fetch Topics": {
            "main": [[{"node": "Plan Content", "type": "main", "index": 0}]]
        },
        "Plan Content": {
            "main": [[
                {"node": "Fetch Prompt", "type": "main", "index": 0},
                {"node": "Fetch Tone", "type": "main", "index": 0}
            ]]
        },
        "Fetch Prompt": {
            "main": [[{"node": "Generate Content", "type": "main", "index": 0}]]
        },
        "Fetch Tone": {
            "main": [[{"node": "Generate Content", "type": "main", "index": 0}]]
        },
        "Generate Content": {
            "main": [[
                {"node": "Parse Content", "type": "main", "index": 0},
                {"node": "Check for Errors", "type": "main", "index": 0}
            ]]
        },
        "Parse Content": {
            "main": [[{"node": "Post to LinkedIn", "type": "main", "index": 0}]]
        },
        "Post to LinkedIn": {
            "main": [[{"node": "Build Log Entry", "type": "main", "index": 0}]]
        },
        "Build Log Entry": {
            "main": [[{"node": "Log to GitHub", "type": "main", "index": 0}]]
        },
        "Check for Errors": {
            "main": [[{"node": "Send Error Alert", "type": "main", "index": 0}]]
        }
    },
    "settings": {
        "executionOrder": "v1"
    }
}
