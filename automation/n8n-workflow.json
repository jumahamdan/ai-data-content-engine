{
    "name": "LinkedIn AI Content Engine",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "cronExpression",
                            "expression": "0 9,16 * * *"
                        }
                    ]
                },
                "timezone": "America/Chicago"
            },
            "id": "cron-trigger",
            "name": "Schedule Trigger",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1,
            "position": [250, 300]
        },
        {
            "parameters": {
                "authentication": "oAuth2",
                "resource": "file",
                "operation": "get",
                "owner": "jumahamdan",
                "repository": "ai-data-content-engine",
                "filePath": "topics/topic-bank.json"
            },
            "id": "fetch-topics",
            "name": "Fetch Topics",
            "type": "n8n-nodes-base.github",
            "typeVersion": 1,
            "position": [450, 300]
        },
        {
            "parameters": {
                "jsCode": "// Content rotation logic\nconst templateRotation = ['interview_explainer', 'architecture', 'optimization', 'layered'];\n\n// Simple state (resets on workflow restart - replace with Redis for persistence)\nconst lastTemplateIndex = 0;\nconst usedTopics = {};\n\n// Rotate to next template\nconst currentTemplateIndex = (lastTemplateIndex + 1) % templateRotation.length;\nconst currentTemplate = templateRotation[currentTemplateIndex];\n\n// Parse topic bank from GitHub response\nlet topicBank;\ntry {\n  const content = $input.item.json.content;\n  // Remove BOM if present and parse\n  const cleanContent = content.replace(/^\\uFEFF/, '');\n  topicBank = JSON.parse(cleanContent);\n} catch (e) {\n  throw new Error('Failed to parse topic bank: ' + e.message + ' | Raw: ' + JSON.stringify($input.item.json).substring(0, 200));\n}\n\nconst availableTopics = topicBank[currentTemplate];\nif (!availableTopics || availableTopics.length === 0) {\n  throw new Error('No topics found for template: ' + currentTemplate);\n}\n\n// Filter out recently used topics\nconst recentlyUsed = usedTopics[currentTemplate] || [];\nconst freshTopics = availableTopics.filter(t => !recentlyUsed.includes(t));\nconst topicsToUse = freshTopics.length > 0 ? freshTopics : availableTopics;\nconst selectedTopic = topicsToUse[0];\n\n// Map template to prompt file\nconst promptFileMap = {\n  'interview_explainer': 'prompts/interview-explainer.md',\n  'architecture': 'prompts/architecture-comparison.md',\n  'optimization': 'prompts/optimization-story.md',\n  'layered': 'prompts/layered-mental-model.md'\n};\n\nreturn {\n  json: {\n    template: currentTemplate,\n    topic: selectedTopic,\n    promptFile: promptFileMap[currentTemplate],\n    timestamp: new Date().toISOString()\n  }\n};"
            },
            "id": "content-planner",
            "name": "Plan Content",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [650, 300]
        },
        {
            "parameters": {
                "authentication": "oAuth2",
                "resource": "file",
                "operation": "get",
                "owner": "jumahamdan",
                "repository": "ai-data-content-engine",
                "filePath": "={{ $json.promptFile }}"
            },
            "id": "fetch-prompt",
            "name": "Fetch Prompt",
            "type": "n8n-nodes-base.github",
            "typeVersion": 1,
            "position": [850, 250]
        },
        {
            "parameters": {
                "authentication": "oAuth2",
                "resource": "file",
                "operation": "get",
                "owner": "jumahamdan",
                "repository": "ai-data-content-engine",
                "filePath": "content-spec/tone.md"
            },
            "id": "fetch-tone",
            "name": "Fetch Tone",
            "type": "n8n-nodes-base.github",
            "typeVersion": 1,
            "position": [850, 350]
        },
        {
            "parameters": {
                "model": "gpt-4",
                "messages": {
                    "values": [
                        {
                            "role": "system",
                            "content": "You are a LinkedIn content creator for a senior data/AI engineer. Generate professional, educational content following the provided template and tone guidelines."
                        },
                        {
                            "role": "user",
                            "content": "=Template:\n{{ $node['Fetch Prompt'].json.content }}\n\nTone Guidelines:\n{{ $node['Fetch Tone'].json.content }}\n\nTopic: {{ $node['Plan Content'].json.topic }}\n\nGenerate a LinkedIn text post with:\n1. Caption (6-12 lines, ending with a thoughtful question to engage readers)\n2. 5-8 relevant hashtags\n\nReturn as JSON: {\"caption\": \"...\", \"hashtags\": [...]}"
                        }
                    ]
                },
                "options": {
                    "temperature": 0.7,
                    "maxTokens": 1000
                }
            },
            "id": "generate-content",
            "name": "Generate Content",
            "type": "n8n-nodes-base.openAi",
            "typeVersion": 1,
            "position": [1050, 300]
        },
        {
            "parameters": {
                "jsCode": "// Parse the OpenAI response\nconst aiResponse = $input.item.json.choices[0].message.content;\n\n// Extract JSON from response (handle markdown code blocks)\nlet contentData;\ntry {\n  const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);\n  contentData = JSON.parse(jsonMatch ? jsonMatch[0] : aiResponse);\n} catch (e) {\n  throw new Error('Failed to parse AI response as JSON: ' + aiResponse);\n}\n\nif (!contentData.caption) {\n  throw new Error('Missing caption in AI response');\n}\n\n// Build full caption with hashtags\nconst hashtags = contentData.hashtags || [];\nconst hashtagString = hashtags.map(h => h.startsWith('#') ? h : '#' + h).join(' ');\nconst fullCaption = hashtags.length > 0 \n  ? `${contentData.caption}\\n\\n${hashtagString}`\n  : contentData.caption;\n\nreturn {\n  json: {\n    caption: contentData.caption,\n    hashtags: hashtags,\n    fullCaption: fullCaption,\n    topic: $node['Plan Content'].json.topic,\n    template: $node['Plan Content'].json.template,\n    timestamp: $node['Plan Content'].json.timestamp\n  }\n};"
            },
            "id": "parse-content",
            "name": "Parse Content",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [1250, 300]
        },
        {
            "parameters": {
                "resource": "post",
                "text": "={{ $json.fullCaption }}"
            },
            "id": "post-linkedin",
            "name": "Post to LinkedIn",
            "type": "n8n-nodes-base.linkedIn",
            "typeVersion": 1,
            "position": [1450, 300],
            "notes": "Text-only post. Add image support later."
        },
        {
            "parameters": {
                "jsCode": "// Build log entry\nconst newEntry = {\n  timestamp: $node['Parse Content'].json.timestamp,\n  template: $node['Parse Content'].json.template,\n  topic: $node['Parse Content'].json.topic,\n  status: 'published',\n  linkedinPostId: $node['Post to LinkedIn'].json.id || 'N/A',\n  caption: $node['Parse Content'].json.caption.substring(0, 100) + '...',\n  hashtags: $node['Parse Content'].json.hashtags\n};\n\nreturn {\n  json: {\n    logEntry: newEntry\n  }\n};"
            },
            "id": "build-log",
            "name": "Build Log Entry",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [1650, 300]
        },
        {
            "parameters": {
                "authentication": "oAuth2",
                "resource": "file",
                "operation": "edit",
                "owner": "jumahamdan",
                "repository": "ai-data-content-engine",
                "filePath": "automation/post_log.json",
                "fileContent": "={{ JSON.stringify({ posts: [$json.logEntry] }, null, 2) }}",
                "commitMessage": "chore: log post {{ $node['Parse Content'].json.timestamp }}"
            },
            "id": "log-to-github",
            "name": "Log to GitHub",
            "type": "n8n-nodes-base.github",
            "typeVersion": 1,
            "position": [1850, 300]
        }
    ],
    "connections": {
        "Schedule Trigger": {
            "main": [[
                {"node": "Fetch Topics", "type": "main", "index": 0}
            ]]
        },
        "Fetch Topics": {
            "main": [[
                {"node": "Plan Content", "type": "main", "index": 0}
            ]]
        },
        "Plan Content": {
            "main": [[
                {"node": "Fetch Prompt", "type": "main", "index": 0},
                {"node": "Fetch Tone", "type": "main", "index": 0}
            ]]
        },
        "Fetch Prompt": {
            "main": [[
                {"node": "Generate Content", "type": "main", "index": 0}
            ]]
        },
        "Fetch Tone": {
            "main": [[
                {"node": "Generate Content", "type": "main", "index": 0}
            ]]
        },
        "Generate Content": {
            "main": [[
                {"node": "Parse Content", "type": "main", "index": 0}
            ]]
        },
        "Parse Content": {
            "main": [[
                {"node": "Post to LinkedIn", "type": "main", "index": 0}
            ]]
        },
        "Post to LinkedIn": {
            "main": [[
                {"node": "Build Log Entry", "type": "main", "index": 0}
            ]]
        },
        "Build Log Entry": {
            "main": [[
                {"node": "Log to GitHub", "type": "main", "index": 0}
            ]]
        }
    },
    "settings": {
        "executionOrder": "v1"
    }
}
